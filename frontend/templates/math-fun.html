<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ariel Learning App 🌟</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/shared.css">
    <link rel="stylesheet" href="/static/css/math.css">
    <script>
        // Jinja2 variables — must be defined before external scripts
        const REWARD_TIERS = {{ reward_tiers | tojson }};
        const SUBJECT = '{{ subject|default("math") }}';
        const SESSION_SLUG = '{{ session_slug|default("") }}';
    </script>
</head>
<body>

<!-- MASCOT -->
<div class="mascot" id="mascot" title="אני הכוכב שלך!">⭐</div>

<!-- MILESTONE OVERLAY -->
<div class="milestone-overlay" id="milestone-overlay">
    <div class="milestone-content">
        <div class="milestone-emoji" id="milestone-emoji">🎉</div>
        <div class="milestone-text" id="milestone-text">כל הכבוד אריאל!</div>
        <div class="milestone-sub" id="milestone-sub"></div>
    </div>
</div>

<!-- CONFETTI CONTAINER -->
<div class="confetti-container" id="confetti-container"></div>

<!-- =====================================================================
     MAIN MENU
     ====================================================================== -->
<div class="screen {% if initial_screen == 'menu' %}active{% endif %}" id="menu-screen">
    <div class="app-header">
        <div class="header-left">
            <a class="home-btn" href="/learning" title="חזרה לבחירת נושא">🏠</a>
        </div>
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="menu-star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="menu-trophy-count">0/6</span></button>
        </div>
    </div>

    <div class="subject-tabs">
        <button class="subject-tab" onclick="switchSubject('english')">🇺🇸 אנגלית</button>
        <button class="subject-tab active" onclick="switchSubject('math')">🔢 חשבון</button>
    </div>

    <div class="menu-subtitle">
        🎮 בחרי משחק, אריאל
    </div>

    <div class="game-cards">
        <div class="game-card game-card-quick-solve-math" id="game-card-1" onclick="startGame(1)">
            <div class="card-emoji">⚡</div>
            <div class="card-text">
                <div class="card-title">פתרי מהר!</div>
                <div class="card-desc">בחרי את התשובה הנכונה</div>
            </div>
        </div>
        <div class="game-card game-card-missing-number-math" id="game-card-2" onclick="startGame(2)">
            <div class="card-emoji">🔍</div>
            <div class="card-text">
                <div class="card-title">מצאי את המספר!</div>
                <div class="card-desc">מהו המספר החסר בתרגיל?</div>
            </div>
        </div>
        <div class="game-card game-card-true-false-math" id="game-card-3" onclick="startGame(3)">
            <div class="card-emoji">🤔</div>
            <div class="card-text">
                <div class="card-title">נכון או לא?</div>
                <div class="card-desc">האם התרגיל נכון?</div>
            </div>
        </div>
        <div class="game-card game-card-bubble-pop-math" id="game-card-4" onclick="startGame(4)">
            <div class="card-emoji">🫧</div>
            <div class="card-text">
                <div class="card-title">פוצצי בועות!</div>
                <div class="card-desc">פוצצי את הבועות עם התשובה הנכונה</div>
            </div>
        </div>
    </div>
</div>

<!-- =====================================================================
     GAME SCREEN
     ====================================================================== -->
<div class="screen" id="game-screen">
    <div class="app-header">
        <div class="header-left">
            <a class="home-btn" href="/learning" title="חזרה לבחירת נושא">🏠</a>
        </div>
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="game-star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="game-trophy-count">0/6</span></button>
        </div>
    </div>

    <div class="game-header">
        <button class="back-btn" onclick="goToMenu(false)">→ חזרה</button>
        <div class="game-title" id="game-title"></div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="round-indicator" id="round-indicator"></div>

    <div id="game-content" style="width: 100%;"></div>
</div>

<!-- =====================================================================
     GAME COMPLETE SCREEN
     ====================================================================== -->
<div class="screen" id="complete-screen">
    <div class="complete-emoji">🎉</div>
    <div class="complete-title">כל הכבוד אריאל!</div>
    <div class="complete-score" id="complete-score"></div>
    <div class="complete-stars" id="complete-total-stars"></div>
    <div class="complete-buttons">
        <button class="complete-btn replay" id="replay-btn">🔄 שחקי שוב</button>
        <button class="complete-btn menu" onclick="goToMenu(false)">🏠 תפריט ראשי</button>
    </div>
</div>

<!-- Session Complete Popup -->
<div class="session-overlay" id="session-overlay">
    <div class="session-popup">
        <div class="session-trophy">🏆</div>
        <div class="session-title">כל הכבוד, את אלופה!</div>
        <div class="session-subtitle">סיימת את כל 4 המשחקים!</div>
        <div class="session-score" id="session-score">0 ⭐</div>
        <div class="session-score-label">כוכבים באימון הזה</div>
        <button class="session-close-btn" onclick="closeSessionPopup()">🌟 יאללה!</button>
    </div>
</div>

<!-- REWARD UNLOCK POPUP -->
<div class="reward-overlay" id="reward-overlay" onclick="closeRewardPopup()">
    <div class="reward-card" onclick="event.stopPropagation()">
        <div class="reward-card-badge">פרס חדש!</div>
        <div class="reward-emoji" id="reward-emoji">✨</div>
        <div class="reward-name" id="reward-name">Spark</div>
        <div class="reward-name-he" id="reward-name-he">ניצוץ</div>
        <div class="reward-desc" id="reward-desc">ההרפתקה רק מתחילה!</div>
        <div class="reward-stars" id="reward-stars">⭐ 25</div>
        <button class="reward-collect-btn" onclick="closeRewardPopup()">🎉 לאוסף שלי</button>
    </div>
</div>

<!-- COLLECTION GALLERY -->
<div class="collection-overlay" id="collection-overlay">
    <div class="collection-panel">
        <div class="collection-header">
            <div class="collection-title">🏆 האוסף שלי</div>
            <button class="collection-close-btn" onclick="closeCollection()">✕</button>
        </div>
        <div class="collection-grid" id="collection-grid"></div>
        <div class="collection-progress" id="collection-progress"></div>
    </div>
</div>

<!-- JS: shared first, then data, then game logic -->
<script src="/static/js/shared.js"></script>
<script src="/static/js/math-data.js"></script>
<script src="/static/js/math-game.js"></script>
<script>
/* State initialization — references localStorage, must be inline */
let state = {
    totalStars: parseInt(localStorage.getItem('ariel_stars') || '0'),
    currentGame: 0,
    currentRound: 0,
    totalRounds: 0,
    gameScore: 0,
    answering: false,
    wordResults: [],
    sessionGames: new Set(JSON.parse(localStorage.getItem('ariel_math_session_games') || '[]')),
    sessionStars: 0,
    bubblesCorrectThisRound: 0,
    bubblesTargetThisRound: 0,
};

/* Initialization */
window.addEventListener('DOMContentLoaded', () => {
    updateStarDisplay();
    loadProgress();

    if (document.getElementById('menu-screen').classList.contains('active')) {
        goToMenu(false);
    }
});
</script>

<footer class="app-version">v{{ version }}</footer>

</body>
</html>
