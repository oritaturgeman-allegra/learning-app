<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ariel Learning App 🌟</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/shared.css">
    <link rel="stylesheet" href="/static/css/english.css">
    <script>
        // Jinja2 variables — must be defined before external scripts
        const REWARD_TIERS = {{ reward_tiers | tojson }};
        const SUBJECT = '{{ subject|default("english") }}';
        const SESSION_SLUG = '{{ session_slug|default("") }}';
    </script>
</head>
<body>

<!-- MASCOT -->
<div class="mascot" id="mascot" title="אני הכוכב שלך!">⭐</div>

<!-- MILESTONE OVERLAY -->
<div class="milestone-overlay" id="milestone-overlay">
    <div class="milestone-content">
        <div class="milestone-emoji" id="milestone-emoji">🎉</div>
        <div class="milestone-text" id="milestone-text">כל הכבוד אריאל!</div>
        <div class="milestone-sub" id="milestone-sub"></div>
    </div>
</div>

<!-- CONFETTI CONTAINER -->
<div class="confetti-container" id="confetti-container"></div>

<!-- =====================================================================
     WELCOME SCREEN
     ====================================================================== -->
<div class="screen {% if initial_screen == 'welcome' %}active{% endif %}" id="welcome-screen">
    <div class="welcome-title">שלום אריאל! 👋</div>
    <div class="welcome-subtitle">בואי ללמוד בכיף 🎉</div>
    <button class="welcome-btn" id="welcome-btn" onclick="goToMenu()">מתחילים ▶️</button>
</div>

<!-- =====================================================================
     SUBJECT PICKER
     ====================================================================== -->
<div class="screen {% if initial_screen == 'subject-picker' %}active{% endif %}" id="subject-picker-screen">
    <div class="app-header">
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="subject-star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="subject-trophy-count">0/6</span></button>
        </div>
    </div>

    <div class="session-picker-header session-picker-header-subjects">
        <h1 class="session-picker-title bounce-in">📚 מה לומדים היום?</h1>
    </div>

    <div class="subject-cards-list">
        <button class="subject-card slide-up" style="animation-delay: 0.1s" onclick="switchSubject('english')">
            <span class="subject-card-emoji">🇺🇸</span>
            <span class="subject-card-name">אנגלית</span>
        </button>
        <button class="subject-card slide-up" style="animation-delay: 0.25s" onclick="switchSubject('math')">
            <span class="subject-card-emoji">🔢</span>
            <span class="subject-card-name">חשבון</span>
        </button>
    </div>
</div>

<!-- =====================================================================
     SESSION PICKER
     ====================================================================== -->
<div class="screen {% if initial_screen == 'session-picker' %}active{% endif %}" id="session-picker-screen">
    <div class="app-header">
        <div class="header-left">
            <a class="home-btn" href="/learning" title="חזרה לבחירת נושא">🏠</a>
        </div>
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="trophy-count">0/6</span></button>
        </div>
    </div>

    <div class="subject-tabs">
        <button class="subject-tab {% if subject == 'english' %}active{% endif %}" onclick="switchSubject('english')">🇺🇸 אנגלית</button>
        <button class="subject-tab {% if subject == 'math' %}active{% endif %}" onclick="switchSubject('math')">🔢 חשבון</button>
    </div>

    <div class="session-picker-header session-picker-header-{{ subject|default('english') }}">
        <h1 class="session-picker-title bounce-in">{% if subject == 'math' %}🔢 חשבון{% else %}🇺🇸 אנגלית{% endif %}</h1>
    </div>
    <div class="session-cards-list session-cards-list-{{ subject|default('english') }}">
        {% for session in sessions|default([]) %}
        <div class="session-card session-card-{{ session.slug }} slide-up" style="animation-delay: {{ 0.1 + loop.index0 * 0.15 }}s" {% if not session.locked %}onclick="selectSession('{{ session.slug }}')"{% endif %}>
            <div class="session-card-emoji">{{ session.emoji }}</div>
            <div class="session-card-info">
                {% if subject == 'math' %}<div class="session-card-name-he">{{ session.name_he }}</div>{% else %}<div class="session-card-name">{{ session.name }}</div>{% endif %}
                <div class="session-card-progress" id="progress-{{ session.slug }}">
                    <span class="session-stars-badge">⭐ <span class="session-star-count">0</span></span>
                </div>
            </div>
            <div class="session-card-check">✓</div>
            <div class="session-card-arrow">←</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- =====================================================================
     MAIN MENU
     ====================================================================== -->
<div class="screen {% if initial_screen == 'menu' %}active{% endif %}" id="menu-screen">
    <div class="app-header">
        <div class="header-left">
            <a class="home-btn" href="/learning" title="חזרה לבחירת נושא">🏠</a>
        </div>
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="menu-star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="menu-trophy-count">0/6</span></button>
            <button class="reset-btn" onclick="confirmReset()" title="התחלה מחדש">🔄</button>
        </div>
    </div>

    <div class="subject-tabs">
        <button class="subject-tab {% if subject == 'english' %}active{% endif %}" onclick="switchSubject('english')">🇺🇸 אנגלית</button>
        <button class="subject-tab {% if subject == 'math' %}active{% endif %}" onclick="switchSubject('math')">🔢 חשבון</button>
    </div>

    <div class="word-tracker" id="word-tracker">
        <div class="word-tracker-header">📖 המילים שלי</div>
        <div class="word-tracker-count" id="word-tracker-count"></div>
        <div class="word-tracker-list" id="word-tracker-list"></div>
    </div>

    <div class="menu-subtitle">
        🎮 בחרי משחק, אריאל
    </div>

    <div class="game-cards">
        <div class="game-card game-card-word-match-english" id="game-card-1" onclick="startGame(1)">
            <div class="card-emoji">🔤</div>
            <div class="card-text">
                <div class="card-title">מה המילה?</div>
                <div class="card-desc">התאימי את המילה באנגלית</div>
            </div>
        </div>
        <div class="game-card game-card-sentence-builder-english" id="game-card-2" onclick="startGame(2)">
            <div class="card-emoji">📝</div>
            <div class="card-text">
                <div class="card-title">תרגמי את המשפט</div>
                <div class="card-desc">סדרי את המילים בסדר הנכון</div>
            </div>
        </div>
        <div class="game-card game-card-listen-choose-english" id="game-card-3" onclick="startGame(3)">
            <div class="card-emoji">🔊</div>
            <div class="card-text">
                <div class="card-title">האזיני ובחרי</div>
                <div class="card-desc">שמעי את המילה ובחרי תמונה</div>
            </div>
        </div>
        <div class="game-card game-card-true-false-english" id="game-card-4" onclick="startGame(4)">
            <div class="card-emoji">🤔</div>
            <div class="card-text">
                <div class="card-title">נכון או לא?</div>
                <div class="card-desc">האם המשפט נכון?</div>
            </div>
        </div>
    </div>
</div>

<!-- =====================================================================
     GAME SCREEN (shared container for all 4 games)
     ====================================================================== -->
<div class="screen" id="game-screen">
    <div class="app-header">
        <div class="header-left">
            <a class="home-btn" href="/learning" title="חזרה לבחירת נושא">🏠</a>
        </div>
        <div class="header-right">
            <div class="star-counter">
                <span class="star-icon">⭐</span>
                <span id="game-star-count">0</span>
            </div>
            <button class="trophy-btn" onclick="openCollection()" title="האוסף שלי">🏆 <span class="trophy-count" id="game-trophy-count">0/6</span></button>
        </div>
    </div>

    <div class="game-header">
        <button class="back-btn" onclick="goToMenu(false)">→ חזרה</button>
        <div class="game-title" id="game-title"></div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="round-indicator" id="round-indicator"></div>

    <!-- Game content injected here -->
    <div id="game-content" style="width: 100%;"></div>
</div>

<!-- =====================================================================
     GAME COMPLETE SCREEN
     ====================================================================== -->
<div class="screen" id="complete-screen">
    <div class="complete-emoji">🎉</div>
    <div class="complete-title">כל הכבוד אריאל!</div>
    <div class="complete-score" id="complete-score"></div>
    <div class="complete-stars" id="complete-total-stars"></div>
    <div class="complete-buttons">
        <button class="complete-btn replay" id="replay-btn">🔄 שחקי שוב</button>
        <button class="complete-btn menu" onclick="goToMenu(false)">🏠 תפריט ראשי</button>
    </div>
</div>

<!-- Session Complete Popup (all 4 games done) -->
<div class="session-overlay" id="session-overlay">
    <div class="session-popup">
        <div class="session-trophy">🏆</div>
        <div class="session-title">!כל הכבוד, את אלופה</div>
        <div class="session-subtitle">!סיימת את כל 4 המשחקים</div>
        <div class="session-score" id="session-score">0 ⭐</div>
        <div class="session-score-label">כוכבים באימון הזה</div>
        <button class="session-close-btn" onclick="closeSessionPopup()">🌟 יאללה!</button>
    </div>
</div>

<!-- REWARD UNLOCK POPUP -->
<div class="reward-overlay" id="reward-overlay" onclick="closeRewardPopup()">
    <div class="reward-card" onclick="event.stopPropagation()">
        <div class="reward-card-badge">פרס חדש!</div>
        <div class="reward-emoji" id="reward-emoji">✨</div>
        <div class="reward-name" id="reward-name">Spark</div>
        <div class="reward-name-he" id="reward-name-he">ניצוץ</div>
        <div class="reward-desc" id="reward-desc">ההרפתקה רק מתחילה!</div>
        <div class="reward-stars" id="reward-stars">⭐ 25</div>
        <button class="reward-collect-btn" onclick="closeRewardPopup()">🎉 לאוסף שלי</button>
    </div>
</div>

<!-- COLLECTION GALLERY -->
<div class="collection-overlay" id="collection-overlay">
    <div class="collection-panel">
        <div class="collection-header">
            <div class="collection-title">🏆 האוסף שלי</div>
            <button class="collection-close-btn" onclick="closeCollection()">✕</button>
        </div>
        <div class="collection-grid" id="collection-grid"></div>
        <div class="collection-progress" id="collection-progress"></div>
    </div>
</div>

<!-- Reset confirmation dialog -->
<div class="reset-dialog-overlay" id="reset-dialog">
    <div class="reset-dialog">
        <div class="reset-dialog-icon">🔄</div>
        <div class="reset-dialog-title">להתחיל סבב חדש?</div>
        <div class="reset-dialog-text">⭐ המילים יתאפסו, הכוכבים נשארים</div>
        <div class="reset-dialog-buttons">
            <button class="reset-dialog-btn confirm" onclick="executeReset()">יאללה!</button>
            <button class="reset-dialog-btn cancel" onclick="closeResetDialog()">ביטול</button>
        </div>
    </div>
</div>

<!-- JS: shared first, then data, then game logic -->
<script src="/static/js/shared.js"></script>
<script src="/static/js/english-data.js"></script>
<script src="/static/js/english-game.js"></script>
<script>
/* State initialization — references localStorage, must be inline */
let state = {
    totalStars: parseInt(localStorage.getItem('ariel_stars') || '0'),
    currentGame: 0,
    currentRound: 0,
    totalRounds: 0,
    gameScore: 0,
    gameData: [],
    answering: false,
    scrambleWords: [],
    wordResults: [],
    sessionGames: new Set(JSON.parse(localStorage.getItem('ariel_session_games') || '[]')),
    sessionStars: 0,
    practicedWords: new Set(),
    sessionPlan: null,
};

/* Initialization */
window.addEventListener('DOMContentLoaded', () => {
    updateStarDisplay();
    loadProgress();

    document.getElementById('welcome-btn').onclick = welcomeClick;

    if (document.getElementById('menu-screen').classList.contains('active')) {
        goToMenu(false);
    }

    if (document.getElementById('session-picker-screen').classList.contains('active')) {
        loadSessionPickerProgress();
    }

    window.addEventListener('resize', () => positionWordTracker());
});
</script>

<footer class="app-version">v{{ version }}</footer>

</body>
</html>
